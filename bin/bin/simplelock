#!/bin/env bash
# copyright Â© blacksuan19 @ 2020
# simplelock: a simple i3 lockscreen with user avatar and fullname

WALL=$HOME/.wallpaper
CACHE_DIR=$HOME/.cache/i3lock
AVATAR=$CACHE_DIR/$USER-pic-crop.png
FULLNAME=`getent passwd $USER | cut -d ":" -f 5 | cut -d "," -f 1`

res=$(xdpyinfo | grep dimensions | sed -r 's/^[^0-9]*([0-9]+x[0-9]+).*$/\1/')
height=$(echo $res | awk -F "x" '{print $2}')
width=$(echo $res | awk -F "x" '{print $1}')
half_width=$((width/2))
half_height=$((height/2))

fg_color=0f111aff
trans_color=00000000
wrong_color=f82a11aa

# make small circle of user avatar
cropuser() {
	convert $HOME/.face -resize 120x120 -gravity Center \( \
		-size 120x120 xc:Black \
		-fill White \
		-draw "circle 60 60 60 1" \
		-alpha Copy\
		\) -compose CopyOpacity -composite -trim $AVATAR
}

# blur and add user avatar
blurwall() {
    # add blur to wallpaper
    convert "$WALL" -blur 0x8 \
        -resize "$res^" -gravity center \
        -extent "$res" "$CACHE_DIR/wallpaper-blur"

    # put user avatar in wallpaper
    composite -geometry "+$((half_width-60))+$((half_height-140))" $AVATAR \
    $CACHE_DIR/wallpaper-blur $CACHE_DIR/resize-pic-sc-blur.png
}


lock() {
	i3lock -n -e --pass-media-keys --pass-screen-keys -i $CACHE_DIR/resize-pic-sc-blur.png \
	--indpos="w/2:h/2-80" --greeterpos="w/2:h/2+10" --greetercolor=$fg_color \
	--insidevercolor=$trans_color --insidewrongcolor=$wrong_color --insidecolor=$trans_color \
	--ringvercolor=$fg_color --ringwrongcolor=$wrong_color --ringcolor=$trans_color \
	--keyhlcolor=c4c5c5ff --bshlcolor=$fg_color --separatorcolor=$trans_color \
	--line-uses-inside --radius 60 --ring-width 3 --indicator --greetersize=20 \
    --wrongtext="" --noinputtext="" --greetertext="$FULLNAME" --veriftext='' --wrongtext=''
}


case $1 in
	-w)
		[ -f $AVATAR ] || cropuser;
        blurwall;;
	*)
		lock;;
esac
